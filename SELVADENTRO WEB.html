<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>SelvaDentro 3D - FINAL CORREGIDO</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.16.0/mapbox-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
  body{margin:0;padding:0;background:#000;overflow:hidden;font-family:Arial,sans-serif}
  #map{position:absolute;top:0;bottom:0;width:100%;height:100%}

  .topButton{
    position:fixed;top:18px;padding:11px 26px;
    background:rgba(0,0,0,0.65);color:white;
    font-weight:bold;font-size:14.5px;border:2px solid white;border-radius:30px;
    cursor:pointer;backdrop-filter:blur(12px);box-shadow:0 6px 20px rgba(0,0,0,0.7);
    transition:all .3s;z-index:2147483647;pointer-events:none;
  }
  .topButton::before{content:"";position:absolute;inset:-10px;pointer-events:auto;}
  .topButton:hover{background:rgba(255,255,255,0.25)}
  .topButton.active{background:white !important;color:black !important}
  #statusButton{left:50%;transform:translateX(-110%);}
  #areaButton{left:50%;transform:translateX(10%);}
  @media(max-width:767px){
    .topButton{top:12px;padding:9px 22px;font-size:14px;}
    #statusButton{transform:translateX(-120%);}
    #areaButton{transform:translateX(20%);}
  }

  /* LEYENDA ÁREA */
  #areaLegend{
    position:fixed;top:74px;left:50%;transform:translateX(-50%);z-index:2000;
    background:rgba(0,0,0,0.9);color:white;padding:8px 12px;border-radius:12px;
    font-size:11px;font-weight:bold;backdrop-filter:blur(12px);
    box-shadow:0 6px 20px rgba(0,0,0,0.7);display:none;
    max-width:95vw;white-space:nowrap;overflow-x:auto;
  }
  #areaLegend .legend-row{display:flex;gap:12px;justify-content:center;align-items:center;}
  #areaLegend .item{display:flex;align-items:center;gap:6px;}
  #areaLegend span{display:inline-block;width:16px;height:16px;border-radius:3px;flex-shrink:0;}

  /* PANEL INFO */
  #infoBox{
    position:absolute;background:rgb(67,81,63);color:white;padding:26px 22px;
    border-radius:32px;
    box-shadow:0 10px 40px rgba(0,0,0,0.7);z-index:1000;max-width:90%;width:380px;
    transition:all .35s ease;opacity:0;visibility:hidden;transform:translateY(20px);overflow:hidden;
  }
  #infoBox.visible{opacity:.98;visibility:visible;transform:translateY(0)}
  @media(min-width:768px){#infoBox{top:30px;left:30px;max-height:95vh;overflow-y:auto;}}
  @media(max-width:767px){
    #infoBox{left:50%;bottom:0;transform:translateX(-50%) translateY(100%);width:100%;max-width:none;
      border-radius:32px 32px 0 0;
      padding-top:110px;padding-bottom:80px;height:100vh;}
    #infoBox.visible{
      transform:translateX(-50%) translateY(0);
      bottom:0;
      top:55% !important;
    }
  }

  .infoBoxContent{
    max-height:100%;overflow-y:auto;padding-right:8px;-webkit-overflow-scrolling:touch;
  }
  @media(max-width:767px){
    .infoBoxContent{
      margin-top:-20px;  /* ← Sube toda la metadata justo debajo del borde superior */
      padding-bottom:120px;
    }
  }

  /* METADATA */
  .metadata-block{margin-bottom:18px;text-align:center}
  .label{font-size:14px;opacity:.85;margin-bottom:4px}
  .value{font-size:22px;font-weight:bold}

  /* ÁREA Y CONSTRUIBLE EN MISMO RENGLÓN */
  .areaConstContainer{
    display:flex;justify-content:center;gap:50px;margin:20px 0;
  }

  /* PRECIO Y ESTADO EN RENGLONES SEPARADOS Y CENTRADOS */
  .priceEstadoContainer{
    display:flex;flex-direction:column;align-items:center;margin:20px 0 30px;
  }

  .contactCard{background:rgba(255,255,255,0.97);color:#333;padding:20px;border-radius:20px;margin-top:30px;box-shadow:0 8px 30px rgba(0,0,0,0.3);}
  .contactCard input,.contactCard textarea{width:100%;padding:11px 14px;margin:9px 0;border-radius:12px;border:1px solid #ccc;font-size:15px;background:#fff;box-sizing:border-box;}
  .contactCard textarea{height:78px;resize:none;}

  #sendBtn{
    width:100%;padding:16px;margin-top:18px;
    background:#D4AF37 !important;color:white !important;
    font-weight:bold;font-size:18px;border:none;border-radius:30px;cursor:pointer;
    box-shadow:0 6px 20px rgba(212,175,55,0.6);
    transition:all .3s;
  }
  #sendBtn:hover{background:#e0c35a !important;transform:translateY(-3px);}
  #sendBtn:disabled{background:#999 !important;cursor:not-allowed;}

  .thankYou{padding:20px;font-size:17px;color:#0b8b0b;background:#f0fff0;border-radius:12px;margin-top:10px;display:none;}

  /* LOGO PRINCIPAL EN ESCRITORIO MÁS PEQUEÑO */
  .infoLogoBig{
    width:48%;max-width:180px;margin:36px auto 16px;display:block;opacity:.95;
  }
  @media(max-width:767px){
    .infoLogoBig{width:68%;max-width:240px;}
  }

  .smallLogoContainer{display:flex;justify-content:center;gap:32px;margin-top:18px}
  .smallLogo{height:26px;opacity:.9;cursor:pointer;transition:opacity .3s;}
  .smallLogo:hover{opacity:1;}

  /* SPLASH LOGO - 25PX MÁS ARRIBA EN MÓVIL */
  #splashLogo{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:420px;max-width:86vw;z-index:1500;pointer-events:none;
    opacity:1;transition:opacity 2.5s ease;
  }
  @media(max-width:767px){
    #splashLogo{
      width:280px;
      transform:translate(-50%,-65%);
    }
  }
</style>
</head>
<body>

<link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js"></script>

<div id="map"></div>
<button id="statusButton" class="topButton">STATUS</button>
<button id="areaButton" class="topButton">ÁREA</button>

<!-- LEYENDA ÁREA -->
<div id="areaLegend">
  <div class="legend-row">
    <div class="item"><span style="background:#E65100"></span>400-599</div>
    <div class="item"><span style="background:#FFC107"></span>600-799</div>
    <div class="item"><span style="background:#66BB6A"></span>800-999</div>
    <div class="item"><span style="background:#2196F3"></span>1000-1299</div>
    <div class="item"><span style="background:#9C27B0"></span>≥1300</div>
  </div>
</div>

<!-- PANEL INFO -->
<div id="infoBox">
  <div class="infoBoxContent">
    <div id="metaLote" class="metadata-block"></div>

    <!-- ÁREA Y CONSTRUIBLE EN MISMO RENGLÓN -->
    <div class="areaConstContainer">
      <div id="metaArea"></div>
      <div id="metaConst"></div>
    </div>

    <!-- PRECIO Y ESTADO EN RENGLONES SEPARADOS Y CENTRADOS -->
    <div class="priceEstadoContainer">
      <div id="metaPrecio"></div>
      <div id="metaEstado"></div>
    </div>

    <div id="contactCard" class="contactCard" style="display:none;">
      <h3>¿Interesado en este lote?</h3>
      <form id="contactForm">
        <input type="text" id="name" placeholder="Nombre completo" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="tel" id="phone" placeholder="Teléfono (opcional)">
        <textarea id="message" placeholder="Mensaje (opcional)"></textarea>
        <button type="submit" id="sendBtn">RESERVAR</button>
      </form>
      <div class="thankYou" id="thankYouMsg">¡Perfecto! Te contactaremos en menos de 24h</div>
    </div>
    <img class="infoLogoBig" src="https://raw.githubusercontent.com/CitiesoftheFuture/selvadentro/main/SELVADENTRO_LOGO.png">
    <div class="smallLogoContainer">
      <a href="https://ama.org.mx/" target="_blank"><img class="smallLogo" src="https://raw.githubusercontent.com/CitiesoftheFuture/selvadentro/main/logo-ama.png" alt="AMA"></a>
      <a href="https://civis.mx/" target="_blank"><img class="smallLogo" src="https://raw.githubusercontent.com/CitiesoftheFuture/selvadentro/main/civis.png" alt="CIVIS"></a>
    </div>
  </div>
</div>

<img id="splashLogo" src="https://raw.githubusercontent.com/CitiesoftheFuture/selvadentro/main/SELVADENTRO_LOGO.png">

<script>
// =====================================================================
// COLORES DE ÁREAS - FÁCIL DE CAMBIAR
// =====================================================================
const AREA_COLORS = {
  400:  "#E65100",  // 400-599 → NARANJA OSCURO
  600:  "#FFC107",  // 600-799 → AMARILLO
  800:  "#66BB6A",  // 800-999 → VERDE MENOS SATURADO
  1000: "#2196F3",  // 1000-1299 → AZUL
  1300: "#9C27B0"   // ≥1300 → MORADO
};
// =====================================================================

mapboxgl.accessToken = "pk.eyJ1IjoibWF1YmVybSIsImEiOiJjbDkwandiMXAwdDJkM3ZvNjhyNGtyYmtvIn0.f8f_PAURro1hU-sh_xnAuA";
emailjs.init('YOUR_PUBLIC_KEY_HERE');
const SERVICE_ID = 'YOUR_SERVICE_ID';
const TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

function getInitialCamera(){
  const w = window.innerWidth;
  if(w > 1200) return {center:{lng:-87.421729,lat:20.296090},zoom:14.44,pitch:69,bearing:90};
  if(w > 768)  return {center:{lng:-87.421729,lat:20.296090},zoom:14.5,pitch:69,bearing:90};
  return {center:{lng:-87.434816,lat:20.281730},zoom:14.14,pitch:69,bearing:180};
}

const map = new mapboxgl.Map({
  container: "map",
  style: "mapbox://styles/mapbox/satellite-v9",
  center: getInitialCamera().center,
  zoom: getInitialCamera().zoom,
  pitch: getInitialCamera().pitch,
  bearing: getInitialCamera().bearing,
  antialias: true,
  fadeDuration: 0
});

const tb = window.tb = new Threebox(map, map.getCanvas().getContext('webgl'), {defaultLights: false});
let statusMode = false, areaMode = false;
let originalMaterials = new WeakMap();
let selectedObject = null, originalMaterial = null;
let currentLot = "";

map.on("style.load", () => {
  map.setPaintProperty('satellite','raster-opacity',0.68);
  map.setPaintProperty('satellite','raster-brightness-min',0.08);

  map.addLayer({
    id: "custom-threebox-model", type: "custom", renderingMode: "3d",
    onAdd: function(){
      const shadowPlane = new THREE.Mesh(new THREE.PlaneGeometry(15000,15000), new THREE.ShadowMaterial({opacity:0.95}));
      shadowPlane.rotation.x = -Math.PI/2; shadowPlane.position.y = 3.8; shadowPlane.receiveShadow = true;
      tb.world.add(shadowPlane);
      tb.world.add(new THREE.HemisphereLight(0xffffff,0x88aa88,0.35));
      const sun = new THREE.DirectionalLight(0xffffff,0.95);
      sun.position.set(1800,3000,2200); sun.castShadow = true;
      sun.shadow.mapSize.width = sun.shadow.mapSize.height = 4096;
      sun.shadow.camera.left = sun.shadow.camera.bottom = -2800;
      sun.shadow.camera.right = sun.shadow.camera.top = 2800;
      tb.world.add(sun);
      tb.world.add(new THREE.AmbientLight(0xffffff,0.01));

      tb.loadObj({
        obj:"https://raw.githubusercontent.com/CitiesoftheFuture/selvadentro/main/SELVA3D.glb",
        type:"gltf", scale:1, units:"meters", rotation:{x:90,y:-90,z:0}
      }, model => {
        model.setCoords([-87.43715249608606,20.30514220104367]);
        model.setRotation({x:0,y:0,z:270});
        model.traverse(c => {
          if(c.isMesh && c.material){
            c.castShadow = c.receiveShadow = true;
            c.material = c.material.clone();
            c.material.color.multiplyScalar(1.35);
            c.material.metalness = 0.02; c.material.roughness = 0.85;
            originalMaterials.set(c, c.material.clone());
          }
        });
        tb.add(model);

        function resetAllMaterials(){
          model.traverse(c=>{if(c.isMesh&&originalMaterials.has(c)){c.material=originalMaterials.get(c).clone();}});
        }

        function applyStatusColors(enable){
          statusMode = enable;
          document.getElementById("statusButton").classList.toggle("active", enable);
          if(enable){ areaMode=false; document.getElementById("areaButton").classList.remove("active"); hideLegend(); }
          if(!enable){ resetAllMaterials(); return; }
          model.traverse(c=>{
            if(c.isMesh && c.userData?.Status){
              const s = c.userData.Status.toString().toLowerCase();
              const col = s.includes("disponible") ? "#00ff00" : (s.includes("reserv")||s.includes("apartado")) ? "#D4AF37" : "#ff0000";
              c.material = c.material.clone();
              c.material.color = new THREE.Color(col);
            }
          });
        }

        function applyAreaColors(enable){
          areaMode = enable;
          document.getElementById("areaButton").classList.toggle("active", enable);
          if(enable){ statusMode=false; document.getElementById("statusButton").classList.remove("active"); }
          if(!enable){ resetAllMaterials(); hideLegend(); return; }
          model.traverse(c=>{
            if(c.isMesh && c.userData?.Area){
              const a = parseFloat(c.userData.Area);
              let col = "#888888";
              if(a >= 1300) col = AREA_COLORS[1300];
              else if(a >= 1000) col = AREA_COLORS[1000];
              else if(a >= 800) col = AREA_COLORS[800];
              else if(a >= 600) col = AREA_COLORS[600];
              else if(a >= 400) col = AREA_COLORS[400];
              c.material = c.material.clone();
              c.material.color = new THREE.Color(col);
            }
          });
          if(enable) showLegend();
        }

        document.getElementById("statusButton").onclick = () => {
          if(document.getElementById("infoBox").classList.contains("visible") && window.innerWidth <= 767)
            document.getElementById("infoBox").classList.remove("visible");
          applyStatusColors(!statusMode);
          if(areaMode) applyAreaColors(false);
        };
        document.getElementById("areaButton").onclick = () => {
          if(document.getElementById("infoBox").classList.contains("visible") && window.innerWidth <= 767)
            document.getElementById("infoBox").classList.remove("visible");
          applyAreaColors(!areaMode);
          if(statusMode) applyStatusColors(false);
        };

        // CERRAR TOCANDO FUERA EN MÓVIL
        const infoBox = document.getElementById("infoBox");
        infoBox.addEventListener("click", e => {
          if(window.innerWidth <= 767 && e.target === infoBox){
            infoBox.classList.remove("visible");
          }
        });

        map.on("click", e => {
          const hits = tb.queryRenderedFeatures(e.point);
          if(selectedObject && originalMaterial){ selectedObject.material = originalMaterial; selectedObject=null; }
          document.getElementById("infoBox").classList.remove("visible");
          document.getElementById("contactCard").style.display = "none";
          if(!hits.length) return;
          if(statusMode) applyStatusColors(false);
          if(areaMode) applyAreaColors(false);

          const obj = hits[0].object;
          selectedObject = obj;
          originalMaterial = obj.material.clone();
          const d = {...(obj.userData||{}), ...(obj.userData?.extras||{})};
          currentLot = d["Index"] || "—";

          const raw = (d["Status"]||"").toString().toLowerCase();
          const isAvailable = raw.includes("disponible");
          const colorEstado = isAvailable ? "#00ff00" : (raw.includes("reserv")||raw.includes("apartado")) ? "#D4AF37" : "#ff0000";

          obj.material = obj.material.clone();
          obj.material.color = new THREE.Color(colorEstado);
          obj.material.emissive = new THREE.Color(0x000000);
          obj.material.emissiveIntensity = 0;
          obj.material.metalness = 0;
          obj.material.roughness = 1;
          obj.material.needsUpdate = true;

          document.getElementById("metaLote").innerHTML = `<div class="label">LOTE</div><div class="value">${currentLot}</div>`;
          // SIN m²
          document.getElementById("metaArea").innerHTML = `<div class="label">ÁREA</div><div class="value">${d["Area"]||"—"}</div>`;
          document.getElementById("metaConst").innerHTML = `<div class="label">CONSTRUIBLE</div><div class="value">${d["Construible"]||"—"}</div>`;
          document.getElementById("metaPrecio").innerHTML = `<div class="label">PRECIO</div><div class="value">$ ${d["Precio"]||"—"}</div>`;
          document.getElementById("metaEstado").innerHTML = `<div class="label">ESTADO</div><div class="value" style="color:${colorEstado}">${isAvailable?"DISPONIBLE":raw.includes("reserv")||raw.includes("apartado")?"RESERVADO":"VENDIDO"}</div>`;
          if(isAvailable) document.getElementById("contactCard").style.display = "block";
          document.getElementById("infoBox").classList.add("visible");
          if(!areaMode) hideLegend();
        });

        document.getElementById("contactForm").onsubmit = function(e){
          e.preventDefault();
          const btn = document.getElementById("sendBtn");
          btn.disabled = true; btn.textContent = "Reservando...";
          emailjs.send(SERVICE_ID, TEMPLATE_ID, {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value || "No proporcionado",
            lot: currentLot,
            message: document.getElementById("message").value || "Sin mensaje"
          }).then(() => {
            document.getElementById("contactForm").style.display = "none";
            document.getElementById("thankYouMsg").style.display = "block";
          }).catch(() => {
            alert("Error al reservar. Inténtalo más tarde.");
            btn.disabled = false; btn.textContent = "RESERVAR";
          });
        };
      });
    },
    render: () => tb.update()
  });
});

// Splash logo fade
let splashFaded = false;
const splashLogo = document.getElementById("splashLogo");
["zoomstart","dragstart","rotatestart","pitchstart","touchstart","mousedown"].forEach(ev =>
  map.once(ev, () => {
    if(!splashFaded){
      splashFaded = true;
      splashLogo.style.opacity = 0;
      setTimeout(() => splashLogo.remove(), 3000);
    }
  })
);

function showLegend() { document.getElementById("areaLegend").style.display = "block"; }
function hideLegend() { document.getElementById("areaLegend").style.display = "none"; }
</script>
</body>
</html>
